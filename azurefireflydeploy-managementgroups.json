{
  "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "managementGroupId": {
      "defaultValue": "[managementGroup().name]",
      "type": "string",
      "metadata": {
        "description": "Management group Id, to assign a role assignment to"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "westus2",
      "metadata": { "description": "Resources location" }
    },
    "servicePrincipalObjectId": {
      "type": "String",
      "metadata": { "description": "Service principal Object Id, needed for Role Assignment" }
    },
    "servicePrincipalClientId": {
      "type": "String",
      "metadata": { "description": "Service principal Client Id" }
    },
    "servicePrincipalClientSecret": {
      "type": "securestring",
      "metadata": { "description": "Service principal client secret" }
    },
    "fireflyAccessKey": {
      "type": "securestring",
      "metadata": { "description": "Firefly access key" }
    },
    "fireflySecretKey": {
      "type": "securestring",
      "metadata": { "description": "Firefly secret key" }
    },
    "subscriptionIdForDeployment": {
      "type": "string",
      "metadata": { "description": "Subscription ID where deployment resources will be created" }
    },
    "eventDrivenEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": { "description": "Enable event-driven monitoring for subscriptions" }
    },
    "fireflyWebhookUrl": {
      "type": "string",
      "defaultValue": "https://azure-events.firefly.ai",
      "metadata": { "description": "Firefly webhook URL for event notifications" }
    },
    "enforceStorageNetworkRules": {
      "type": "bool",
      "defaultValue": false,
      "metadata": { "description": "Enforce storage network rules to restrict access to Firefly IPs only" }
    },
    "fireflyEips": {
      "type": "array",
      "defaultValue": [
        "3.224.145.192",
        "54.83.245.177",
        "3.213.167.195",
        "54.146.252.237",
        "34.226.97.113"
      ],
      "metadata": { "description": "Firefly IP addresses for storage account network rules" }
    },
    "tags": {
      "type": "array",
      "defaultValue": [],
      "metadata": { "description": "Tags to apply to created resources as array from EditableGrid" }
    },
    "isProd": {
      "type": "bool",
      "defaultValue": false,
      "metadata": { "description": "Is this a production environment" }
    },
    "directoryDomain": {
      "type": "string",
      "defaultValue": "firefly.ai",
      "metadata": { "description": "Directory domain for Firefly integration" }
    },
    "newguid": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "Just a Guid to append to deployment script name"
      }
    }
  },
  "variables": {
    "tagsArray": "[parameters('tags')]",
    "customTagsObject": "[if(empty(variables('tagsArray')), createObject(), reduce(variables('tagsArray'), createObject(), lambda('accumulator', 'currentTag', union(lambdaVariables('accumulator'), createObject(lambdaVariables('currentTag').tagName, lambdaVariables('currentTag').tagValue)))))]",
    "mergedTags": "[union(createObject('firefly', 'true'), variables('customTagsObject'))]",
    "resourceGroupName": "[concat('firefly-monitoring-mg-', parameters('managementGroupId'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "[concat('firefly-resource-group-', parameters('newguid'))]",
      "subscriptionId": "[parameters('subscriptionIdForDeployment')]",
      "location": "[parameters('location')]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[variables('resourceGroupName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('mergedTags')]",
              "properties": {}
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "name": "[guid(parameters('managementGroupId'), 'firefly reader mg', parameters('servicePrincipalObjectId'), parameters('newguid'))]",
      "properties": {
        "roleDefinitionId": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'), '/providers/Microsoft.Authorization/roleDefinitions/', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
        "principalId": "[parameters('servicePrincipalObjectId')]",
        "principalType": "ServicePrincipal",
        "scope": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'))]"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "name": "[guid(parameters('managementGroupId'), 'firefly billing reader mg', parameters('servicePrincipalObjectId'), parameters('newguid'))]",
      "properties": {
        "roleDefinitionId": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'), '/providers/Microsoft.Authorization/roleDefinitions/', 'fa23ad8b-c56e-40d8-ac0c-ce449e1d2c64')]",
        "principalId": "[parameters('servicePrincipalObjectId')]",
        "principalType": "ServicePrincipal",
        "scope": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'))]"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "name": "[guid(parameters('managementGroupId'), 'firefly app config reader mg', parameters('servicePrincipalObjectId'), parameters('newguid'))]",
      "properties": {
        "roleDefinitionId": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'), '/providers/Microsoft.Authorization/roleDefinitions/', '516239f1-63e1-4d78-a4de-a74fb236a071')]",
        "principalId": "[parameters('servicePrincipalObjectId')]",
        "principalType": "ServicePrincipal",
        "scope": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'))]"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "name": "[guid(parameters('managementGroupId'), 'firefly security reader mg', parameters('servicePrincipalObjectId'), parameters('newguid'))]",
      "properties": {
        "roleDefinitionId": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'), '/providers/Microsoft.Authorization/roleDefinitions/', '39bc4728-0917-49c7-9d2c-d95423bc2eb4')]",
        "principalId": "[parameters('servicePrincipalObjectId')]",
        "principalType": "ServicePrincipal",
        "scope": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'))]"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-10-01-preview",
      "name": "[guid(parameters('managementGroupId'), 'firefly monitoring reader mg', parameters('servicePrincipalObjectId'), parameters('newguid'))]",
      "properties": {
        "roleDefinitionId": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'), '/providers/Microsoft.Authorization/roleDefinitions/', '43d0d8ad-25c7-4714-9337-8ba259a9fe05')]",
        "principalId": "[parameters('servicePrincipalObjectId')]",
        "principalType": "ServicePrincipal",
        "scope": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'))]"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "[concat('firefly-roles-', parameters('newguid'))]",
      "subscriptionId": "[parameters('subscriptionIdForDeployment')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('firefly-resource-group-', parameters('newguid'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "customRoleName": { "type": "string" },
            "servicePrincipalObjectId": { "type": "string" },
            "newguid": { "type": "string" }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleDefinitions",
              "apiVersion": "2022-04-01",
              "name": "[guid('fireflyCustomRole', subscription().subscriptionId)]",
              "properties": {
                "roleName": "[parameters('customRoleName')]",
                "description": "Firefly's requested permissions",
                "type": "customRole",
                "permissions": [
                  {
                "actions": [
                      "Microsoft.Storage/storageAccounts/listkeys/action",
                      "Microsoft.DocumentDB/databaseAccounts/listConnectionStrings/action",
                      "Microsoft.DocumentDB/databaseAccounts/listKeys/action",
                      "Microsoft.DocumentDB/databaseAccounts/readonlykeys/action",
                      "Microsoft.ContainerService/managedClusters/listClusterUserCredential/action",
                      "Microsoft.Web/sites/config/list/Action",
                      "Microsoft.Cache/redis/listKeys/action",
                      "Microsoft.AppConfiguration/configurationStores/ListKeys/action",
                      "Microsoft.Search/searchServices/listQueryKeys/action",
                      "Microsoft.Search/searchServices/listAdminKeys/action",
                      "Microsoft.Authorization/roleAssignments/read",
                      "Microsoft.OperationalInsights/workspaces/sharedkeys/action"
                    ],
                    "notActions": [],
                    "dataActions": [],
                    "notDataActions": []
                  }
                ],
                "assignableScopes": ["[concat('/subscriptions/', subscription().subscriptionId)]"]
              }
            },
            {
              "type": "Microsoft.Authorization/roleDefinitions",
              "apiVersion": "2022-04-01",
              "name": "[guid('fireflyStorageBlobReader', subscription().subscriptionId)]",
              "properties": {
                "roleName": "[concat('Firefly-StorageBlobReader-', uniqueString(subscription().subscriptionId))]",
                "description": "Firefly's storage blob read permissions",
                "type": "customRole",
                "permissions": [
                  {
                    "actions": [],
                    "notActions": [],
                    "dataActions": ["Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read"],
                    "notDataActions": []
                  }
                ],
                "assignableScopes": ["[concat('/subscriptions/', subscription().subscriptionId)]"]
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('servicePrincipalObjectId'), 'StorageBlobDataReaderConditional', subscription().subscriptionId, parameters('newguid'))]",
              "properties": {
                "roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                "principalId": "[parameters('servicePrincipalObjectId')]",
                "principalType": "ServicePrincipal",
                "conditionVersion": "2.0",
                "condition": "((!(ActionMatches{'Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read'} AND NOT SubOperationMatches{'Blob.List'})) OR (@Resource[Microsoft.Storage/storageAccounts/blobServices/containers/blobs:path] StringLike '*state') OR (@Resource[Microsoft.Storage/storageAccounts/blobServices/containers/blobs:path] StringLike '*.tfstateenv:*'))"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-10-01-preview",
              "name": "[guid('firefly custom role deployment subscription', subscription().subscriptionId, parameters('servicePrincipalObjectId'), parameters('newguid'))]",
              "properties": {
                "roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', guid('fireflyCustomRole', subscription().subscriptionId))]",
                "principalId": "[parameters('servicePrincipalObjectId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[guid('fireflyCustomRole', subscription().subscriptionId)]"
              ]
            }
          ]
        },
        "parameters": {
          "customRoleName": {
            "value": "[concat('Firefly-MG-', uniqueString(parameters('managementGroupId')))]"
          },
          "servicePrincipalObjectId": {
            "value": "[parameters('servicePrincipalObjectId')]"
          },
          "newguid": {
            "value": "[parameters('newguid')]"
          }
        }
      }
    },
    {
      "condition": "[parameters('eventDrivenEnabled')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "[concat('firefly-resources-', parameters('newguid'))]",
      "subscriptionId": "[parameters('subscriptionIdForDeployment')]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "dependsOn": [
        "[concat('firefly-resource-group-', parameters('newguid'))]",
        "[concat('firefly-roles-', parameters('newguid'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "storageAccountName": { "type": "string" },
            "eventGridTopicName": { "type": "string" },
            "servicePrincipalObjectId": { "type": "string" },
            "newguid": { "type": "string" },
            "mergedTags": { "type": "object" },
            "enforceStorageNetworkRules": { "type": "bool" },
            "fireflyEips": { "type": "array" },
            "location": { "type": "string" },
            "fireflyWebhookUrl": { "type": "string" },
            "subscriptionId": { "type": "string" }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-09-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('mergedTags')]",
              "sku": { "name": "Standard_LRS" },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": true,
                "crossTenantReplicationEnabled": false,
                "minimumTlsVersion": "TLS1_2",
                "networkAcls": "[if(parameters('enforceStorageNetworkRules'), createObject('defaultAction', 'Deny', 'ipRules', map(parameters('fireflyEips'), lambda('ip', createObject('value', lambdaVariables('ip'), 'action', 'Allow')))), createObject('defaultAction', 'Allow'))]"
              }
            },
            {
              "type": "Microsoft.EventGrid/systemTopics",
              "apiVersion": "2021-12-01",
              "name": "[parameters('eventGridTopicName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('mergedTags')]",
              "properties": {
                "source": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                "topicType": "microsoft.storage.storageaccounts"
              },
              "dependsOn": ["[parameters('storageAccountName')]"]
            },
            {
              "type": "Microsoft.EventGrid/systemTopics/eventSubscriptions",
              "apiVersion": "2021-12-01",
              "name": "[concat(parameters('eventGridTopicName'), '/firefly-webhook')]",
              "dependsOn": ["[parameters('eventGridTopicName')]"],
              "properties": {
                "destination": {
                  "endpointType": "WebHook",
                  "properties": {
                    "endpointUrl": "[parameters('fireflyWebhookUrl')]",
                    "maxEventsPerBatch": 1,
                    "preferredBatchSizeInKilobytes": 64
                  }
                },
                "filter": { "includedEventTypes": ["Microsoft.Storage.BlobCreated"] },
                "eventDeliverySchema": "EventGridSchema",
                "retryPolicy": { "maxDeliveryAttempts": 30, "eventTimeToLiveInMinutes": 1440 }
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('servicePrincipalObjectId'), 'StorageBlobDataReader', parameters('storageAccountName'), parameters('newguid'))]",
              "scope": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
              "properties": {
                "roleDefinitionId": "[concat('/subscriptions/', parameters('subscriptionId'), '/providers/Microsoft.Authorization/roleDefinitions/', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                "principalId": "[parameters('servicePrincipalObjectId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": ["[parameters('storageAccountName')]"]
            }
          ]
        },
        "parameters": {
          "storageAccountName": { "value": "[concat('firefly', uniqueString(parameters('subscriptionIdForDeployment')))]" },
          "eventGridTopicName": { "value": "[concat('firefly-mg-', substring(parameters('managementGroupId'), 0, 8), '-', parameters('newguid'))]" },
          "servicePrincipalObjectId": { "value": "[parameters('servicePrincipalObjectId')]" },
          "newguid": { "value": "[parameters('newguid')]" },
          "mergedTags": { "value": "[variables('mergedTags')]" },
          "enforceStorageNetworkRules": { "value": "[parameters('enforceStorageNetworkRules')]" },
          "fireflyEips": { "value": "[parameters('fireflyEips')]" },
          "location": { "value": "[parameters('location')]" },
          "fireflyWebhookUrl": { "value": "[parameters('fireflyWebhookUrl')]" },
          "subscriptionId": { "value": "[parameters('subscriptionIdForDeployment')]" }
        }
      }
    },
    {
      "condition": "[parameters('eventDrivenEnabled')]",
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "name": "[concat('firefly-mg-diagnostics-', parameters('newguid'))]",
      "scope": "[concat('/providers/Microsoft.Management/managementGroups/', parameters('managementGroupId'))]",
      "dependsOn": [
        "[concat('firefly-resources-', parameters('newguid'))]"
      ],
      "properties": {
        "storageAccountId": "[concat('/subscriptions/', parameters('subscriptionIdForDeployment'), '/resourceGroups/', variables('resourceGroupName'), '/providers/Microsoft.Storage/storageAccounts/firefly', uniqueString(parameters('subscriptionIdForDeployment')))]",
        "logs": [
          {
            "category": "Administrative",
            "enabled": true,
            "retentionPolicy": {
              "enabled": true,
              "days": 0
            }
          }
        ]
      }
    },
    {
      "condition": "[parameters('eventDrivenEnabled')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "[concat('firefly-mg-subscription-diagnostics-', parameters('newguid'))]",
      "subscriptionId": "[parameters('subscriptionIdForDeployment')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[concat('firefly-resources-', parameters('newguid'))]",
        "[concat('firefly-mg-diagnostics-', parameters('newguid'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "managementGroupId": { "type": "string" },
            "storageAccountName": { "type": "string" },
            "resourceGroupName": { "type": "string" },
            "newguid": { "type": "string" },
            "subscriptionIdForDeployment": { "type": "string" }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "[concat('firefly-mg-diagnostics-script-', parameters('newguid'))]",
              "location": "[deployment().location]",
              "kind": "AzurePowerShell",
              "properties": {
                "retentionInterval": "PT1H",
                "timeout": "PT30M",
                "cleanupPreference": "Always",
                "azPowerShellVersion": "8.1",
                "environmentVariables": [
                  { "name": "MANAGEMENT_GROUP_ID", "value": "[parameters('managementGroupId')]" },
                  { "name": "STORAGE_ACCOUNT_ID", "value": "[concat('/subscriptions/', parameters('subscriptionIdForDeployment'), '/resourceGroups/', parameters('resourceGroupName'), '/providers/Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]" },
                  { "name": "SUBSCRIPTION_ID", "value": "[parameters('subscriptionIdForDeployment')]" }
                ],
                "scriptContent": "# Get all subscriptions under the management group and create diagnostic settings\nWrite-Host \"Setting up diagnostic settings for all subscriptions under management group: $Env:MANAGEMENT_GROUP_ID\"\n\ntry {\n    # Get all subscriptions under the management group\n    $mgHierarchy = Get-AzManagementGroup -GroupName $Env:MANAGEMENT_GROUP_ID -Expand -Recurse -ErrorAction Stop\n    \n    function Get-SubscriptionIds($node) {\n        $subscriptionIds = @()\n        if ($node.Children) {\n            foreach ($child in $node.Children) {\n                if ($child.Type -eq '/subscriptions') {\n                    $subscriptionIds += $child.Name\n                } elseif ($child.Type -eq '/providers/Microsoft.Management/managementGroups') {\n                    $subscriptionIds += Get-SubscriptionIds $child\n                }\n            }\n        }\n        return $subscriptionIds\n    }\n    \n    $allSubscriptionIds = Get-SubscriptionIds $mgHierarchy\n    Write-Host \"Found $($allSubscriptionIds.Count) subscriptions to configure\"\n    \n    $successCount = 0\n    $failedSubscriptions = @()\n    \n    foreach ($subId in $allSubscriptionIds) {\n        try {\n            Write-Host \"Setting up diagnostic settings for subscription: $subId\"\n            \n            # Switch to the subscription context\n            Set-AzContext -SubscriptionId $subId -ErrorAction Stop | Out-Null\n            \n            # Check if diagnostic setting already exists\n            $existingDiagnostics = Get-AzDiagnosticSetting -ResourceId \"/subscriptions/$subId\" -ErrorAction SilentlyContinue\n            $diagnosticName = \"firefly-mg-diagnostics-$subId\"\n            \n            if ($existingDiagnostics | Where-Object { $_.Name -eq $diagnosticName }) {\n                Write-Host \"Diagnostic setting already exists for subscription $subId, updating...\"\n            } else {\n                Write-Host \"Creating new diagnostic setting for subscription $subId\"\n            }\n            \n            # Create/Update diagnostic setting for subscription activity logs\n            $logCategories = @(\n                @{ Category = 'Administrative'; Enabled = $true }\n                @{ Category = 'Security'; Enabled = $true }\n                @{ Category = 'ServiceHealth'; Enabled = $true }\n                @{ Category = 'Alert'; Enabled = $true }\n                @{ Category = 'Recommendation'; Enabled = $true }\n                @{ Category = 'Policy'; Enabled = $true }\n                @{ Category = 'Autoscale'; Enabled = $true }\n                @{ Category = 'ResourceHealth'; Enabled = $true }\n            )\n            \n            $diagnosticSetting = Set-AzDiagnosticSetting -ResourceId \"/subscriptions/$subId\" -Name $diagnosticName -StorageAccountId $Env:STORAGE_ACCOUNT_ID -Log $logCategories -Enabled $true\n            \n            if ($diagnosticSetting) {\n                Write-Host \"✓ Successfully configured diagnostic settings for subscription $subId\"\n                $successCount++\n            } else {\n                Write-Warning \"Failed to configure diagnostic settings for subscription $subId\"\n                $failedSubscriptions += $subId\n            }\n            \n        } catch {\n            Write-Warning \"Error configuring diagnostic settings for subscription $subId : $($_.Exception.Message)\"\n            $failedSubscriptions += $subId\n        }\n    }\n    \n    Write-Host \"`n=== DIAGNOSTIC SETTINGS SUMMARY ===\"\n    Write-Host \"Total subscriptions: $($allSubscriptionIds.Count)\"\n    Write-Host \"Successfully configured: $successCount\"\n    Write-Host \"Failed: $($failedSubscriptions.Count)\"\n    \n    if ($failedSubscriptions.Count -gt 0) {\n        Write-Host \"Failed subscriptions: $($failedSubscriptions -join ', ')\"\n    }\n    \n} catch {\n    Write-Error \"Failed to configure diagnostic settings: $($_.Exception.Message)\"\n    exit 1\n}\n\nWrite-Host \"Diagnostic settings configuration completed\""
              }
            }
          ]
        },
        "parameters": {
          "managementGroupId": { "value": "[parameters('managementGroupId')]" },
          "storageAccountName": { "value": "[concat('firefly', uniqueString(parameters('subscriptionIdForDeployment')))]" },
          "resourceGroupName": { "value": "[variables('resourceGroupName')]" },
          "newguid": { "value": "[parameters('newguid')]" },
          "subscriptionIdForDeployment": { "value": "[parameters('subscriptionIdForDeployment')]" }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "[concat('firefly-integration-', parameters('newguid'))]",
      "subscriptionId": "[parameters('subscriptionIdForDeployment')]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "dependsOn": [
        "[concat('firefly-resource-group-', parameters('newguid'))]",
        "[concat('firefly-roles-', parameters('newguid'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "managementGroupId": { "type": "string" },
            "servicePrincipalClientId": { "type": "string" },
            "servicePrincipalClientSecret": { "type": "securestring" },
            "fireflyAccessKey": { "type": "securestring" },
            "fireflySecretKey": { "type": "securestring" },
            "isProd": { "type": "bool" },
            "directoryDomain": { "type": "string" },
            "eventDrivenEnabled": { "type": "bool" },
            "newguid": { "type": "string" },
            "location": { "type": "string" }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "[concat('firefly-integration-script-', parameters('newguid'))]",
              "location": "[parameters('location')]",
              "kind": "AzurePowerShell",
              "properties": {
                "retentionInterval": "PT1H",
                "timeout": "PT30M",
                "cleanupPreference": "Always",
                "azPowerShellVersion": "8.1",
                "environmentVariables": [
                  { "name": "MANAGEMENT_GROUP_ID", "value": "[parameters('managementGroupId')]" },
                  { "name": "CLIENT_ID", "value": "[parameters('servicePrincipalClientId')]" },
                  { "name": "CLIENT_SECRET", "secureValue": "[parameters('servicePrincipalClientSecret')]" },
                  { "name": "FIREFLY_ACCESS_KEY", "secureValue": "[parameters('fireflyAccessKey')]" },
                  { "name": "FIREFLY_SECRET_KEY", "secureValue": "[parameters('fireflySecretKey')]" },
                  { "name": "TENANT_ID", "value": "[tenant().tenantId]" },
                  { "name": "IS_PROD", "value": "[parameters('isProd')]" },
                  { "name": "IS_EVENT_DRIVEN", "value": "[parameters('eventDrivenEnabled')]" },
                  { "name": "IS_AUTO_DISCOVER", "value": "true" },
                  { "name": "DIRECTORY_DOMAIN", "value": "[parameters('directoryDomain')]" }
                ],
                "scriptContent": "# Authenticate with Firefly\nWrite-Host \"Authenticating with Firefly API...\"\ntry {\n    $authBody = @{\n        accessKey = $Env:FIREFLY_ACCESS_KEY\n        secretKey = $Env:FIREFLY_SECRET_KEY\n    } | ConvertTo-Json -Compress\n    \n    $tokenResp = Invoke-WebRequest -SkipCertificateCheck -ContentType 'application/json' -Method Post -Uri 'https://prodapi.firefly.ai/api/account/access_keys/login' -Body $authBody\n    $tokenObj = $tokenResp.Content | ConvertFrom-Json\n    $jwt = $tokenObj.access_token\n    \n    if (-not $jwt) { \n        Write-Error 'Failed to obtain access token from Firefly API'\n        exit 1 \n    }\n    Write-Host \"Successfully authenticated with Firefly API\"\n} catch {\n    Write-Error \"Firefly authentication failed: $($_.Exception.Message)\"\n    exit 1\n}\n\n# Login to Azure\nWrite-Host \"Logging into Azure...\"\ntry {\n    $securePassword = ConvertTo-SecureString $Env:CLIENT_SECRET -AsPlainText -Force\n    $credential = New-Object System.Management.Automation.PSCredential($Env:CLIENT_ID, $securePassword)\n    $azContext = Connect-AzAccount -ServicePrincipal -Credential $credential -Tenant $Env:TENANT_ID\n    Write-Host \"Successfully logged into Azure. Tenant: $($azContext.Context.Tenant.Id)\"\n} catch {\n    Write-Error \"Azure authentication failed: $($_.Exception.Message)\"\n    exit 1\n}\n\n# Get all subscriptions under the management group\nWrite-Host \"Getting subscriptions under management group: $Env:MANAGEMENT_GROUP_ID\"\ntry {\n    $mgHierarchy = Get-AzManagementGroup -GroupName $Env:MANAGEMENT_GROUP_ID -Expand -Recurse -ErrorAction Stop\n    Write-Host \"Successfully retrieved management group hierarchy\"\n} catch {\n    Write-Error \"Failed to get management group $Env:MANAGEMENT_GROUP_ID : $($_.Exception.Message)\"\n    exit 1\n}\n\n# Function to extract subscription IDs from hierarchy\nfunction Get-SubscriptionIds($node) {\n    $subscriptionIds = @()\n    if ($node.Children) {\n        foreach ($child in $node.Children) {\n            if ($child.Type -eq '/subscriptions') {\n                $subscriptionIds += $child.Name\n                Write-Host \"Found subscription: $($child.DisplayName) ($($child.Name))\"\n            } elseif ($child.Type -eq '/providers/Microsoft.Management/managementGroups') {\n                Write-Host \"Processing child management group: $($child.DisplayName)\"\n                $subscriptionIds += Get-SubscriptionIds $child\n            }\n        }\n    }\n    return $subscriptionIds\n}\n\n$allSubscriptionIds = Get-SubscriptionIds $mgHierarchy\nWrite-Host \"Found $($allSubscriptionIds.Count) total subscriptions under management group\"\n\nif ($allSubscriptionIds.Count -eq 0) {\n    Write-Warning \"No subscriptions found under management group $Env:MANAGEMENT_GROUP_ID\"\n    exit 0\n}\n\n$headers = @{ \n    'Authorization' = \"Bearer $jwt\"\n    'Content-Type' = 'application/json'\n    'Accept' = 'application/json'\n}\n$successCount = 0\n$failedSubscriptions = @()\n\n# Process each subscription individually\nforeach ($subId in $allSubscriptionIds) {\n    try {\n        Write-Host \"Processing subscription: $subId\"\n        \n        # Get subscription details\n        try {\n            $subscription = Get-AzSubscription -SubscriptionId $subId -ErrorAction Stop\n            $subscriptionDisplayName = $subscription.Name\n            Write-Host \"Subscription details - Name: $subscriptionDisplayName, State: $($subscription.State)\"\n        } catch {\n            Write-Warning \"Could not retrieve subscription details for $subId. Using ID as name.\"\n            $subscriptionDisplayName = $subId\n        }\n        \n        # Skip disabled subscriptions\n        if ($subscription.State -eq 'Disabled') {\n            Write-Warning \"Skipping disabled subscription: $subscriptionDisplayName ($subId)\"\n            continue\n        }\n        \n        Write-Host \"Creating Firefly integration for subscription: $subscriptionDisplayName ($subId)\"\n        \n        # Prepare integration payload\n        $integrationPayload = [ordered]@{\n            subscriptionId = $subId\n            tenantId = $Env:TENANT_ID\n            applicationId = $Env:CLIENT_ID\n            clientSecret = $Env:CLIENT_SECRET\n            name = \"$subscriptionDisplayName (MG: $Env:MANAGEMENT_GROUP_ID)\"\n            directoryDomain = $Env:DIRECTORY_DOMAIN\n            isProd = [bool]::Parse($Env:IS_PROD)\n            isEventDriven = [bool]::Parse($Env:IS_EVENT_DRIVEN)\n            isAutoDiscover = [bool]::Parse($Env:IS_AUTO_DISCOVER)\n            isIacAutoDiscoveryDisabled = $false\n        }\n        \n        $jsonPayload = $integrationPayload | ConvertTo-Json -Compress\n        Write-Host \"Payload: $jsonPayload\"\n        \n        # Make API call to create integration\n        try {\n            $apiResponse = Invoke-WebRequest -UseBasicParsing -SkipCertificateCheck -Method Post -Uri 'https://prodapi.firefly.ai/api/integrations/azure?onConflictUpdate=true' -Headers $headers -Body $jsonPayload -ErrorAction Stop\n            \n            if ($apiResponse.StatusCode -eq 200 -or $apiResponse.StatusCode -eq 201) {\n                Write-Host \"✓ Successfully created integration for subscription: $subscriptionDisplayName ($subId)\"\n                $successCount++\n            } else {\n                Write-Warning \"⚠ Unexpected status code $($apiResponse.StatusCode) for subscription $subscriptionDisplayName ($subId)\"\n                Write-Host \"Response: $($apiResponse.Content)\"\n                $failedSubscriptions += @{Id=$subId; Name=$subscriptionDisplayName; Reason=\"HTTP $($apiResponse.StatusCode)\"}\n            }\n        } catch {\n            $errorMsg = $_.Exception.Message\n            if ($_.Exception.Response) {\n                $errorMsg += \" | Status: $($_.Exception.Response.StatusCode)\"\n                if ($_.Exception.Response.Content) {\n                    $errorMsg += \" | Response: $($_.Exception.Response.Content)\"\n                }\n            }\n            Write-Warning \"✗ Failed to create integration for subscription $subscriptionDisplayName ($subId): $errorMsg\"\n            $failedSubscriptions += @{Id=$subId; Name=$subscriptionDisplayName; Reason=$errorMsg}\n        }\n        \n        # Small delay to avoid rate limiting\n        Start-Sleep -Milliseconds 500\n        \n    } catch {\n        Write-Warning \"✗ Error processing subscription $subId : $($_.Exception.Message)\"\n        $failedSubscriptions += @{Id=$subId; Name=$subId; Reason=$_.Exception.Message}\n    }\n}\n\n# Summary\nWrite-Host \"`n=== INTEGRATION SUMMARY ===\"\nWrite-Host \"Total subscriptions found: $($allSubscriptionIds.Count)\"\nWrite-Host \"Successful integrations: $successCount\"\nWrite-Host \"Failed integrations: $($failedSubscriptions.Count)\"\n\nif ($failedSubscriptions.Count -gt 0) {\n    Write-Host \"`nFailed subscriptions:\"\n    $failedSubscriptions | ForEach-Object { \n        Write-Host \" - $($_.Name) ($($_.Id)) - Reason: $($_.Reason)\" \n    }\n}\n\nif ($successCount -eq 0 -and $allSubscriptionIds.Count -gt 0) {\n    Write-Error \"All subscription integrations failed\"\n    exit 1\n} elseif ($successCount -gt 0) {\n    Write-Host \"✓ Integration process completed successfully with $successCount successful integrations\"\n} else {\n    Write-Host \"No subscriptions were processed\"\n}"
              }
            }
          ]
        },
        "parameters": {
          "managementGroupId": { "value": "[parameters('managementGroupId')]" },
          "servicePrincipalClientId": { "value": "[parameters('servicePrincipalClientId')]" },
          "servicePrincipalClientSecret": { "value": "[parameters('servicePrincipalClientSecret')]" },
          "fireflyAccessKey": { "value": "[parameters('fireflyAccessKey')]" },
          "fireflySecretKey": { "value": "[parameters('fireflySecretKey')]" },
          "isProd": { "value": "[parameters('isProd')]" },
          "directoryDomain": { "value": "[parameters('directoryDomain')]" },
          "eventDrivenEnabled": { "value": "[parameters('eventDrivenEnabled')]" },
          "newguid": { "value": "[parameters('newguid')]" },
          "location": { "value": "[parameters('location')]" }
        }
      }
    }
  ],
  "outputs": {
    "deploymentSummary": {
      "type": "object",
      "value": {
        "managementGroupId": "[parameters('managementGroupId')]",
        "subscriptionIdForDeployment": "[parameters('subscriptionIdForDeployment')]",
        "resourceGroup": "[variables('resourceGroupName')]",
        "totalSubscriptions": "Discovered dynamically under management group",
        "eventDrivenEnabled": "[parameters('eventDrivenEnabled')]",
        "deploymentMethod": "Management-Group-Simplified"
      }
    }
  }
} 